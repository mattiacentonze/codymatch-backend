stages:
  - test
  - build

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "production"'
    - when: never

test:
  stage: test
  image: node:24-alpine
  services:
    - name: postgres:15-alpine
      alias: postgres
  variables:
    POSTGRES_DB: test-db
    DB_NAME: test-db
    POSTGRES_USER: testuser
    DB_USER: testuser
    POSTGRES_PASSWORD: codymatch
    DB_HOST: postgres
    POSTGRES_PORT: 5432
    NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .npm
  before_script:
    - set -o allexport && . ./tests/.env.test && set +o allexport
    - apk add --no-cache postgresql-client
    - npm ci --cache ./.npm
    - |
      until pg_isready -h $DB_HOST -p $POSTGRES_PORT; do
        echo "Waiting for Postgresâ€¦"
        sleep 1
      done
  script:
    - npm run test

build:
  stage: build
  image: docker:28
  variables:
    BRANCH: $CI_COMMIT_BRANCH
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u "$CI_REGISTRY_USER" --password-stdin
    - docker buildx create --use --name ci || docker buildx use ci
  script:
    - |
      docker buildx build \
        --build-arg BRANCH="$BRANCH" \
        -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA" \
        -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH" \
        --push .
    - |
      if [ "$CI_COMMIT_BRANCH" = "production" ]; then
        docker buildx build \
          --build-arg BRANCH="$BRANCH" \
          -t "$CI_REGISTRY_IMAGE:latest" \
          --push .
      fi